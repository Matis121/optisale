<% content_for :title, "Integracja #{@integration.name}" %>
<%= render Ui::Layout::Container::DefaultComponent.new do %>
  <!-- Header with breadcrumb and title -->
  <div class="mb-8">
    <div class="flex items-center gap-2 text-sm breadcrumbs mb-4">
      <ul>
        <li><%= link_to "Integracje", integrations_path, class: "text-base-content/60 hover:text-base-content" %></li>
        <li class="text-base-content"><%= @integration.name %></li>
      </ul>
    </div>
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-3xl font-bold text-base-content"><%= @integration.name %></h1>
        <p class="text-base-content/60 mt-2">
          Integracja z <%= @integration.provider.humanize %>
        </p>
      </div>
      <div class="flex items-center gap-3">
        <%= link_to "Edytuj", edit_integration_path(@integration), class: "btn btn-outline" %>
        <%= link_to "Usuń", integration_path(@integration), 
                    data: { turbo_method: :delete, turbo_confirm: "Czy na pewno chcesz usunąć tę integrację?" }, 
                    class: "btn btn-error btn-outline" %>
      </div>
    </div>
  </div>
  <!-- Test result flash -->
  <% if @test_result %>
    <div class="alert <%= @test_result[:success] ? 'alert-success' : 'alert-error' %> mb-6">
      <i class="fas fa-<%= @test_result[:success] ? 'check-circle' : 'exclamation-triangle' %>"></i>
      <span><%= @test_result[:message] %></span>
    </div>
  <% end %>
  <!-- Main content layout -->
  <div class="grid lg:grid-cols-3 gap-8">
    <!-- Main info -->
    <div class="lg:col-span-2 space-y-4">
      <!-- Status card -->
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body">
          <h3 class="card-title text-lg">Status integracji</h3>
          <div class="space-y-4">
            <div>
              <p class="text-sm text-base-content/60 mb-2">Status aktywności</p>
              <div class="flex items-center gap-2">
                <% if @integration.active? %>
                  <span class="badge badge-success">
                    <i class="fas fa-check-circle mr-1"></i>
                    Aktywna
                  </span>
                <% else %>
                  <span class="badge badge-ghost">
                    <i class="fas fa-pause-circle mr-1"></i>
                    Nieaktywna
                  </span>
                <% end %>
              </div>
            </div>
            <div>
              <p class="text-sm text-base-content/60 mb-2">Status połączenia</p>
              <div class="flex items-center gap-2">
                <% case @integration.status %>
                <% when 'active' %>
                  <span class="badge badge-info">
                    <i class="fas fa-wifi mr-1"></i>
                    Połączona
                  </span>
                <% when 'error' %>
                  <span class="badge badge-error">
                    <i class="fas fa-exclamation-triangle mr-1"></i>
                    Błąd
                  </span>
                <% else %>
                  <span class="badge badge-warning">
                    <i class="fas fa-clock mr-1"></i>
                    Nieprzetestowana
                  </span>
                <% end %>
              </div>
            </div>
          </div>
          <% if @integration.error_message.present? %>
            <div class="alert alert-warning mt-4">
              <i class="fas fa-exclamation-triangle"></i>
              <div>
                <p class="font-semibold">Ostatni błąd:</p>
                <p class="text-sm"><%= @integration.error_message %></p>
              </div>
            </div>
          <% end %>
        </div>
      </div>
      <!-- Connection info -->
      <div class="card bg-base-100 shadow-sm border border-base-200">
        <div class="card-body">
          <h3 class="card-title text-lg">Informacje o połączeniu</h3>
          <div class="space-y-3">
            <div>
              <p class="text-sm text-base-content/60">Provider</p>
              <p class="font-medium"><%= @integration.provider.humanize %></p>
            </div>
            <% case @integration.provider %>
            <% when 'fakturownia' %>
              <div>
                <p class="text-sm text-base-content/60">Konto</p>
                <p class="font-mono text-sm"><%= @integration.credentials['account'] %>.fakturownia.pl</p>
              </div>
              <div>
                <p class="text-sm text-base-content/60">Token API</p>
                <p class="text-sm">
                  <% if @integration.credentials['api_token'].present? %>
                    <span class="badge badge-success badge-sm">Ustawiony</span>
                  <% else %>
                    <span class="badge badge-ghost badge-sm">Brak</span>
                  <% end %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    <!-- Sidebar with status and info -->
    <div class="lg:col-span-1">
      <div class="space-y-4">
        <!-- Quick actions -->
        <div class="card bg-base-100 shadow-sm border border-base-200">
          <div class="card-body">
            <h3 class="card-title text-lg">Akcje</h3>
            <div class="space-y-3">
              <% unless @integration.ready? %>
                <%= link_to test_integration_path(@integration), 
                          data: { turbo_method: :post }, 
                          class: "btn btn-primary btn-block" do %>
                  <i class="fas fa-test-tube mr-2"></i>
                  Testuj połączenie
                <% end %>
              <% end %>
              <%= link_to invoices_path(invoicing_integration_id: @integration.id), 
                        class: "btn btn-outline btn-block" do %>
                <i class="fas fa-file-invoice mr-2"></i>
                Zobacz faktury
              <% end %>
            </div>
          </div>
        </div>
        <!-- Stats -->
        <div class="card bg-base-100 shadow-sm border border-base-200">
          <div class="card-body">
            <h3 class="card-title text-lg">Statystyki</h3>
            <div class="space-y-3">
              <div class="flex justify-between">
                <span class="text-base-content/60">Faktury utworzone</span>
                <span class="font-bold">
                  <%= @integration.user.invoices.where(invoicing_integration_id: @integration.id).count %>
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-base-content/60">Utworzona</span>
                <span class="text-sm">
                  <%= @integration.created_at.strftime("%d.%m.%Y") %>
                </span>
              </div>
              <% if @integration.last_sync_at.present? %>
                <div class="flex justify-between">
                  <span class="text-base-content/60">Ostatnia synchronizacja</span>
                  <span class="text-sm">
                    <%= @integration.last_sync_at.strftime("%d.%m.%Y %H:%M") %>
                  </span>
                </div>
              <% end %>
            </div>
            <% if @integration.last_sync_at.present? %>
              <p class="text-xs text-base-content/50 mt-4">
                <i class="fas fa-clock mr-1"></i>
                Ostatnia synchronizacja: <%= time_ago_in_words(@integration.last_sync_at) %> temu
              </p>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<% end %>
