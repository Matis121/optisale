<%= render Ui::Layout::Container::DefaultComponent.new do %>
  <!-- Top Cards -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
    <!-- Welcome Card -->
    <div class="lg:col-span-2">
      <div class="card bg-gradient-to-r from-primary/5 to-primary/10 border border-primary/20 shadow-sm h-full">
        <div class="card-body p-6 flex justify-center">
          <h1 class="text-2xl font-semibold text-base-content">
            Witaj z powrotem, <%= current_user.email.split('@').first.capitalize %>! 
          </h1>
        </div>
      </div>
    </div>
    <!-- What's New Banner -->
    <div class="lg:col-span-1">
      <div class="h-full">
        <div class="card bg-gradient-to-r from-primary/5 to-primary/10 border border-primary/20 shadow-sm h-full blur-[1px] opacity-50 pointer-events-none">
          <div class="card-body p-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 flex items-center justify-center rounded-full bg-primary/20">
                <i class="fas fa-rocket text-xl text-primary"></i>
              </div>
              <div class="flex-1">
                <div class="font-semibold text-base text-base-content">Nowoci w systemie</div>
                <div class="text-sm text-base-content/60">Sprawd藕 aktualizacje</div>
              </div>
              <i class="fas fa-arrow-right text-base-content/40"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Stats Grid -->
  <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Wszystkie zam贸wienia -->
    <div class="card  border border-gray-500/30 shadow-sm hover:shadow-md transition-all p-5">
      <div class="flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-medium text-base-content/60 uppercase tracking-wide">Zam贸wienia</span>
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary/10">
            <i class="fas fa-shopping-cart text-sm text-primary"></i>
          </div>
        </div>
        <div class="text-3xl font-bold text-base-content mb-1"><%= @orders_count %></div>
        <div class="text-xs text-base-content/60">Wszystkie zam贸wienia</div>
      </div>
    </div>
    <!-- Produkty -->
    <div class="card  border border-gray-500/30 shadow-sm hover:shadow-md transition-all p-5">
      <div class="flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-medium text-base-content/60 uppercase tracking-wide">Produkty</span>
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary/10">
            <i class="fas fa-box text-sm text-primary"></i>
          </div>
        </div>
        <div class="text-3xl font-bold text-base-content mb-1"><%= @products_count %></div>
        <div class="text-xs text-base-content/60">W katalogach</div>
      </div>
    </div>
    <!-- Faktury -->
    <div class="card  border border-gray-500/30 shadow-sm hover:shadow-md transition-all p-5">
      <div class="flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-medium text-base-content/60 uppercase tracking-wide">Faktury</span>
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary/10">
            <i class="fas fa-file-invoice text-sm text-primary"></i>
          </div>
        </div>
        <div class="text-3xl font-bold text-base-content mb-1"><%= @invoices_count %></div>
        <div class="text-xs text-base-content/60">Wygenerowanych</div>
      </div>
    </div>
    <!-- Dzisiaj -->
    <div class="card  border border-gray-500/30 shadow-sm hover:shadow-md transition-all p-5">
      <div class="flex flex-col">
        <div class="flex items-center justify-between mb-2">
          <span class="text-xs font-medium text-base-content/60 uppercase tracking-wide">Dzisiaj</span>
          <div class="w-8 h-8 flex items-center justify-center rounded-lg bg-primary/10">
            <i class="fas fa-calendar-day text-sm text-primary"></i>
          </div>
        </div>
        <div class="text-3xl font-bold text-base-content mb-1"><%= @today_orders_count %></div>
        <div class="text-xs text-base-content/60">Dzisiejsze zam贸wienia</div>
      </div>
    </div>
  </div>
  <!-- Main Content Grid -->
  <div class="card border border-gray-500/30 shadow-sm min-h-full">
    <div class="card-body p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold flex items-center gap-2">
          <i class="fas fa-chart-line text-primary"></i>
          Aktualny miesic
        </h2>
        <%= link_to orders_path, class: "btn btn-sm btn-ghost gap-2" do %>
          Zobacz wszystkie
          <i class="fas fa-arrow-right"></i>
        <% end %>
      </div>
      <% if @monthly_orders.values.sum > 0 %>
        <div class="w-full" style="height: 400px;">
          <canvas id="ordersChart"></canvas>
        </div>
      <% else %>
        <div class="text-center py-12">
          <div class="w-20 h-20 mx-auto mb-4 flex items-center justify-center rounded-full bg-base-200">
            <i class="fas fa-inbox text-4xl text-base-content/20"></i>
          </div>
          <p class="text-base-content/60 mb-4">Brak zam贸wie w tym miesicu</p>
          <%= button_to orders_path, method: :post, remote: true, class: "btn btn-primary btn-sm gap-2" do %>
            <i class="fas fa-plus text-xs"></i>
            Utw贸rz pierwsze zam贸wienie
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <% content_for :head do %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <% end %>
  <% if @monthly_orders.values.sum > 0 %>
    <script>
      function initOrdersChart() {
        const ctx = document.getElementById('ordersChart');
        if (!ctx) return;

        // Destroy existing chart instance if it exists to prevent duplicates
        if (window.ordersChartInstance) {
          window.ordersChartInstance.destroy();
        }

        const chartData = <%= raw @monthly_orders.to_json %>;
        const labels = Object.keys(chartData).map(date => {
          const d = new Date(date);
          return d.toLocaleDateString('pl-PL', { day: '2-digit', month: '2-digit' });
        });
        const data = Object.values(chartData);

        window.ordersChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'Liczba zam贸wie',
              data: data,
              borderColor: 'rgb(99, 102, 241)',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
              pointHoverRadius: 6,
              pointBackgroundColor: 'var(--color-primary)',
              pointBorderColor: '#fff',
              pointBorderWidth: 2
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#fff',
                  font: {
                    size: 12,
                    family: "'Inter', sans-serif"
                  }
                }
              },
              tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                padding: 12,
                titleFont: {
                  size: 14
                },
                bodyFont: {
                  size: 13
                },
                borderColor: 'rgba(99, 102, 241, 0.5)',
                borderWidth: 1
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  color: '#fff'
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.2)'
                }
              },
              x: {
                ticks: {
                  color: '#fff',
                  maxRotation: 45,
                  minRotation: 45
                },
                grid: {
                  color: 'rgba(0, 0, 0, 0.2)'
                }
              }
            }
          }
        });
      }

      // Support both Turbo and regular page loads
      document.addEventListener('turbo:load', initOrdersChart);
      document.addEventListener('DOMContentLoaded', initOrdersChart);

      // Also handle browser back/forward cache
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
          initOrdersChart();
        }
      });
    </script>
  <% end %>
<% end %>
