<% content_for :title, "Zamówienie ##{@order.id}" %>
<%= render Ui::Layout::Container::DefaultComponent.new do %>
  <div class="flex gap-4">
    <!-- Sidebar -->
    <div class="w-50">
      <div class="fixed flex flex-col gap-4 items-center w-50">
        <%= button_to orders_path, method: :post, remote: true, class: "btn btn-primary btn-sm gap-2 w-44" do %>
          <i class="fas fa-plus text-xs"></i>
          Nowe zamówienie
        <% end %>
        <%= render "status_sidebar" %>
        <%= link_to order_statuses_path, class: "btn btn-dash btn-sm gap-2 w-fit" do %>
          <i class="fas fa-plus text-xs"></i>
          Dodaj status
        <% end %>
      </div>
    </div>
    <!-- Main content -->
    <div class="flex-1">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <div>
          <h1 class="text-lg font-bold text-base-content">Zamówienie #<%= @order.id %></h1>
          <p class="text-base-content/60 mt-1 text-xs">
            <%= @order.addresses.find_by(kind: :delivery)&.fullname.presence || "Brak danych klienta" %> • 
            <%= @order.created_at.strftime('%d.%m.%Y %H:%M') %>
          </p>
        </div>
        <div class="flex items-center gap-3">
          <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-outline btn-sm gap-2">
              <i class="fas fa-ellipsis-v"></i>
              Akcje
            </div>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-200">
              <li>
                <%= link_to order_path(@order), data: { turbo_method: :delete, turbo_confirm: "Czy na pewno chcesz usunąć to zamówienie?" }, class: "w-full cursor-pointer text-error" do %>
                  <i class="fas fa-trash text-error"></i> Usuń zamówienie
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Products Table -->
      <div class="mb-8">
        <div class="overflow-x-auto">
          <%= render(Ui::Order::ProductTableComponent.new(order: @order)) %>
        </div>
      </div>
      <!-- Add Product Modal -->
      <%= render(Ui::Order::AddProductModalComponent.new(order: @order, current_account: current_account)) %>
      <!-- Order Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
        <!-- Payment, Status, Invoices -->
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6">
          <div class="space-y-8">
            <!-- Payment Details -->
            <div>
              <%= render(Ui::Order::Info::Payment::Component.new(order: @order)) %>
            </div>
            <div>
              <div class="space-y-2">
                <%= turbo_frame_tag dom_id(@order, :status) do %>
                  <%= form_with(model: @order, class: "flex gap-2") do |form| %>
                    <% current_status = @order_statuses.find { |s| s.id == @order.status_id } %>
                    <div class="dropdown dropdown-down flex-1 border border-gray-500/30 rounded-md">
                      <label tabindex="0" class="btn btn-ghost btn-sm border border-base-200 gap-2 w-full justify-between">
                        <div class="flex items-center gap-2">
                          <span class="w-3 h-3 rounded-sm flex-shrink-0" style="background-color: <%= current_status&.color || '#gray' %>;"></span>
                          <span><%= current_status&.full_name || 'Wybierz status' %></span>
                        </div>
                        <i class="fas fa-chevron-down text-xs"></i>
                      </label>
                      <ul tabindex="0" class="dropdown-content menu p-2 shadow-lg bg-base-100 rounded-lg w-full border border-base-200 max-h-[85vh] overflow-y-auto">
                        <% if @ungrouped_statuses.any? %>
                          <% @ungrouped_statuses.each do |status| %>
                            <li>
                              <button type="button" onclick="document.getElementById('status_id_<%= status.id %>').checked = true; this.closest('ul').previousElementSibling.querySelector('span:last-child').textContent = '<%= status.full_name %>'; this.closest('ul').previousElementSibling.querySelector('span:first-child').style.backgroundColor = '<%= status.color %>';" class="text-sm flex items-center gap-2 w-full text-left">
                                <span class="w-3 h-3 rounded-sm flex-shrink-0" style="background-color: <%= status.color %>;"></span>
                                <%= status.full_name %>
                              </button>
                              <%= form.radio_button :status_id, status.id, id: "status_id_#{status.id}", class: "hidden" %>
                            </li>
                          <% end %>
                        <% end %>
                        <% @order_status_groups.each do |group| %>
                          <li class="menu-title">
                            <span class="text-xs font-semibold text-base-content/60"><%= group.name %></span>
                          </li>
                          <% group.order_statuses.order(:position).each do |status| %>
                            <li>
                              <button type="button" onclick="document.getElementById('status_id_<%= status.id %>').checked = true; this.closest('ul').previousElementSibling.querySelector('span:last-child').textContent = '<%= status.full_name %>'; this.closest('ul').previousElementSibling.querySelector('span:first-child').style.backgroundColor = '<%= status.color %>';" class="text-sm flex items-center gap-2 w-full text-left">
                                <span class="w-3 h-3 rounded-sm flex-shrink-0" style="background-color: <%= status.color %>;"></span>
                                <%= status.full_name %>
                              </button>
                              <%= form.radio_button :status_id, status.id, id: "status_id_#{status.id}", class: "hidden" %>
                            </li>
                          <% end %>
                        <% end %>
                      </ul>
                    </div>
                    <%= form.submit "Zmień status", class: "btn btn-sm btn-primary" %>
                  <% end %>
                <% end %>
              </div>
            </div>
            <!-- Status -->
            <!-- Invoices & Receipts -->
            <div>
              <div class="flex flex-col justify-between items-center">
                <p>Nowe faktury i paragony:</p>
                <span class="text-sm text-base-content/60">Faktury:</span>
                <%= button_to invoices_path, method: :post, remote: true, params: { order_id: @order.id }, class: "btn btn-outline btn-sm gap-1" do %>
                  <i class="fas fa-file-invoice"></i>
                  Wystaw faktury
                <% end %>
                ------------------
                <br>
                <br>
                <br>
              </div>
              <div class="space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-base-content/60">Paragon:</span>
                  <button class="btn btn-outline btn-sm gap-1">
                    <i class="fas fa-receipt"></i>
                    Wystaw paragon
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Customer Data, Order Details, Extra Fields -->
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6">
          <div class="space-y-6">
            <!-- Customer Info -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Dane klienta</h4>
              <%= render(Ui::Order::Info::Customer::Component.new(order: @order)) %>
            </div>
            <!-- Order Details -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Szczegóły zamówienia</h4>
              <%= render(Ui::Order::Info::OrderDetails::Component.new(order: @order)) %>
            </div>
            <!-- Extra Fields -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Pola dodatkowe</h4>
              <%= render(Ui::Order::Info::ExtraFields::Component.new(order: @order)) %>
            </div>
          </div>
        </div>
      </div>
      <!-- Addresses -->
      <div class="grid grid-cols-3 gap-4">
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6">
          <h4 class="font-medium text-base-content mb-3">Adres dostawy</h4>
          <%= render(Ui::Order::Address::Shipping::Component.new(order: @order, address_type: :delivery)) %>
        </div>
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6">
          <h4 class="font-medium text-base-content mb-3">Dane do faktury</h4>
          <%= render(Ui::Order::Address::Shipping::Component.new(order: @order, address_type: :invoice)) %>
        </div>
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6">
          <h4 class="font-medium text-base-content mb-3">Punkt odbioru</h4>
          <%= render(Ui::Order::Address::PickupPoint::Component.new(order: @order)) %>
        </div>
      </div>
    </div>
  </div>
<% end %>