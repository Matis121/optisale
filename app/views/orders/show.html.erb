<% content_for :title, "Zamówienie ##{@order.id}" %>
<%= render Ui::Layout::Container::DefaultComponent.new do %>
  <div class="flex gap-4">
    <!-- Sidebar -->
    <div class="w-50">
      <div class="fixed flex flex-col gap-4 items-center w-50">
        <%= button_to orders_path, method: :post, remote: true, class: "btn btn-primary btn-sm gap-2 w-44" do %>
          <i class="fas fa-plus text-xs"></i>
          Nowe zamówienie
        <% end %>
        <%= render "status_sidebar" %>
        <%= link_to order_statuses_path, class: "btn btn-dash btn-sm gap-2 w-fit" do %>
          <i class="fas fa-plus text-xs"></i>
          Dodaj status
        <% end %>
      </div>
    </div>
    <!-- Main content -->
    <div class="flex-1">
      <!-- Header -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <div>
          <h1 class="text-lg font-bold text-base-content">Zamówienie #<%= @order.id %></h1>
          <p class="text-base-content/60 mt-1 text-xs">
            <%= @order.addresses.find_by(kind: :delivery)&.fullname.presence || "Brak danych klienta" %> • 
            <%= @order.created_at.strftime('%d.%m.%Y %H:%M') %>
          </p>
          <div class="mt-4 flex items-center gap-1">
            <%= render partial: "orders/tag_dropdown", locals: { order: @order, available_tags: @available_tags } %>
            <%= render partial: "orders/tags", locals: { order: @order, available_tags: @available_tags } %>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-outline btn-sm gap-2">
              <i class="fas fa-ellipsis-v"></i>
              Akcje
            </div>
            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow-xl bg-base-100 rounded-box w-48 border border-base-200">
              <li>
                <%= link_to order_path(@order), data: { turbo_method: :delete, turbo_confirm: "Czy na pewno chcesz usunąć to zamówienie?" }, class: "w-full cursor-pointer text-error" do %>
                  <i class="fas fa-trash text-error"></i> Usuń zamówienie
                <% end %>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- Products Table -->
      <div class="mb-8">
        <div class="overflow-x-auto">
          <%= render(Ui::Order::ProductTableComponent.new(order: @order)) %>
        </div>
      </div>
      <!-- Add Product Modal -->
      <%= render(Ui::Order::AddProductModalComponent.new(order: @order, current_account: current_account)) %>
      <!-- Order Information -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-8">
        <!-- Payment, Status, Invoices -->
        <div class="border border-gray-500/30 rounded-lg p-5 bg-base-300">
          <div class="space-y-4">
            <!-- Płatność & Status -->
            <div class="grid grid-cols-1 2xl:grid-cols-2 gap-4 items-start">
              <!-- Płatność -->
              <div>
                <%= render(Ui::Order::Info::Payment::Component.new(order: @order)) %>
              </div>
              <!-- Status -->
              <%= turbo_frame_tag dom_id(@order, :status) do %>
                <%= form_with(model: @order, class: "flex gap-2") do |form| %>
                  <% current_status = @order_statuses.find { |s| s.id == @order.status_id } %>
                  <div class="dropdown dropdown-down flex-1">
                    <label tabindex="0" class="btn btn-ghost btn-sm border border-gray-500/30 gap-2 w-full justify-between hover:border-gray-500/50">
                      <div class="flex items-center gap-2">
                        <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= current_status&.color || '#gray' %>;"></span>
                        <span class="text-sm"><%= current_status&.full_name || 'Wybierz status' %></span>
                      </div>
                      <i class="fas fa-chevron-down text-xs opacity-50"></i>
                    </label>
                    <ul tabindex="0" class="dropdown-content menu p-2 shadow-xl bg-base-100 rounded-lg w-full border border-base-200 max-h-[85vh] overflow-y-auto z-50 mt-1">
                      <% if @ungrouped_statuses.any? %>
                        <% @ungrouped_statuses.each do |status| %>
                          <li>
                            <button type="button" onclick="document.getElementById('status_id_<%= status.id %>').checked = true; this.closest('ul').previousElementSibling.querySelector('span:last-child').textContent = '<%= status.full_name %>'; this.closest('ul').previousElementSibling.querySelector('span:first-child').style.backgroundColor = '<%= status.color %>';" class="text-sm flex items-center gap-2 w-full text-left hover:bg-base-200">
                              <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= status.color %>;"></span>
                              <%= status.full_name %>
                            </button>
                            <%= form.radio_button :status_id, status.id, id: "status_id_#{status.id}", class: "hidden" %>
                          </li>
                        <% end %>
                      <% end %>
                      <% @order_status_groups.each do |group| %>
                        <li class="menu-title pt-2">
                          <span class="text-xs font-semibold text-base-content/50 uppercase tracking-wider"><%= group.name %></span>
                        </li>
                        <% group.order_statuses.order(:position).each do |status| %>
                          <li>
                            <button type="button" onclick="document.getElementById('status_id_<%= status.id %>').checked = true; this.closest('ul').previousElementSibling.querySelector('span:last-child').textContent = '<%= status.full_name %>'; this.closest('ul').previousElementSibling.querySelector('span:first-child').style.backgroundColor = '<%= status.color %>';" class="text-sm flex items-center gap-2 w-full text-left hover:bg-base-200">
                              <span class="w-2.5 h-2.5 rounded-full flex-shrink-0" style="background-color: <%= status.color %>;"></span>
                              <%= status.full_name %>
                            </button>
                            <%= form.radio_button :status_id, status.id, id: "status_id_#{status.id}", class: "hidden" %>
                          </li>
                        <% end %>
                      <% end %>
                    </ul>
                  </div>
                  <%= form.submit "Zmień", class: "btn btn-sm btn-primary" %>
                <% end %>
              <% end %>
            </div>
            <div class="divider my-3"></div>
            <!-- Dokumenty -->
            <%= render "invoice_section", order: @order %>
            <div class="divider my-3"></div>
            <!-- Akcje -->
            <div class="flex flex-wrap gap-2">
              <button class="btn btn-ghost btn-sm border border-gray-500/30 hover:border-gray-500/50">
                <i class="fas fa-tag text-xs"></i>
                Generuj etykietę
              </button>
              <button class="btn btn-ghost btn-sm border border-gray-500/30 hover:border-gray-500/50">
                <i class="fas fa-truck text-xs"></i>
                Wyślij do kuriera
              </button>
              <button class="btn btn-ghost btn-sm border border-gray-500/30 hover:border-gray-500/50">
                <i class="fas fa-sync text-xs"></i>
                Synchronizuj
              </button>
              <!-- Tutaj będą kolejne przyciski akcji... -->
            </div>
          </div>
        </div>
        <!-- Customer Data, Order Details, Extra Fields -->
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6 bg-base-300">
          <div class="space-y-6">
            <!-- Customer Info -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Dane klienta</h4>
              <%= render(Ui::Order::Info::Customer::Component.new(order: @order)) %>
            </div>
            <!-- Order Details -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Szczegóły zamówienia</h4>
              <%= render(Ui::Order::Info::OrderDetails::Component.new(order: @order)) %>
            </div>
            <!-- Extra Fields -->
            <div>
              <h4 class="font-medium text-base-content mb-3">Pola dodatkowe</h4>
              <%= render(Ui::Order::Info::ExtraFields::Component.new(order: @order)) %>
            </div>
          </div>
        </div>
      </div>
      <!-- Addresses -->
      <div class="grid grid-cols-3 gap-4">
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6 bg-base-300">
          <h4 class="font-medium text-base-content mb-3">Adres dostawy</h4>
          <%= render(Ui::Order::Address::Shipping::Component.new(order: @order, address_type: :delivery)) %>
        </div>
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6 bg-base-300">
          <h4 class="font-medium text-base-content mb-3">Dane do faktury</h4>
          <%= render(Ui::Order::Address::Shipping::Component.new(order: @order, address_type: :invoice)) %>
        </div>
        <div class="rounded-md border border-gray-500/30 shadow-sm p-6 bg-base-300">
          <h4 class="font-medium text-base-content mb-3">Punkt odbioru</h4>
          <%= render(Ui::Order::Address::PickupPoint::Component.new(order: @order)) %>
        </div>
      </div>
    </div>
  </div>
<% end %>